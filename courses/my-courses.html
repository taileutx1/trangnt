<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kh√≥a h·ªçc c·ªßa t√¥i - TAILIEUTX1</title>
  <meta name="description" content="Danh s√°ch c√°c kh√≥a h·ªçc b·∫°n ƒë√£ s·ªü h·ªØu">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#ec4899',
            accent: '#f472b6',
            danger: '#dc2626',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gradient-to-br from-pink-50 to-purple-50 min-h-screen">

  <!-- HEADER (gi·ªëng index1.html) -->
  <header class="bg-gradient-to-r from-primary to-accent text-white shadow-2xl sticky top-0 z-40">
    <div class="container mx-auto px-4 py-5 flex justify-between items-center">
    

      <nav class="hidden md:flex items-center space-x-6 text-lg font-medium">
        <a href="index1.html" class="hover:opacity-80 transition">Trang ch·ªß</a>
        <button onclick="openActivateModal()" class="bg-white text-primary px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition">
          K√≠ch ho·∫°t m√£
        </button>

        <button id="desktop-login-btn" onclick="window.location.href='login.html'" 
                class="bg-white text-primary px-6 py-2 rounded-full font-bold hover:bg-gray-100 transition">
          ƒêƒÉng nh·∫≠p
        </button>

        <div id="desktop-user-info" class="hidden relative">
          <button onclick="toggleDropdown('desktop-dropdown')" class="focus:outline-none">
            <div class="w-10 h-10 rounded-full p-1 bg-gradient-to-br from-primary to-accent transition-transform duration-300 hover:scale-105 hover:shadow-lg">
              <img id="desktop-user-avatar" src="" alt="Avatar" class="w-full h-full rounded-full bg-white">
            </div>
          </button>
          <div id="desktop-dropdown" class="absolute right-0 top-full mt-3 w-56 bg-white rounded-2xl shadow-2xl overflow-hidden hidden z-50">
            <div class="px-5 py-4 border-b border-pink-100">
              <p class="font-bold text-primary" id="desktop-username"></p>
              <p class="text-sm text-gray-600 mt-1 truncate" id="desktop-email"></p>
            </div>
            <button onclick="logout()" class="block w-full text-left px-5 py-4 text-gray-800 hover:bg-pink-100 transition font-semibold">
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </nav>

      <button aria-label="M·ªü menu" class="md:hidden flex flex-col space-y-1.5 hamburger" onclick="toggleMobileMenu()">
        <span class="block w-8 h-1 bg-white transition-transform"></span>
        <span class="block w-8 h-1 bg-white transition-transform"></span>
        <span class="block w-8 h-1 bg-white transition-transform"></span>
      </button>
    </div>

    <nav id="mobile-menu" class="md:hidden mt-6 flex-col space-y-4 hidden px-4 pb-4">
      <a href="index1.html" class="block py-2 text-lg hover:opacity-80">Trang ch·ªß</a>
      <button onclick="openActivateModal(); toggleMobileMenu()" class="bg-white text-primary px-6 py-3 rounded-full font-bold w-full hover:bg-gray-100">
        K√≠ch ho·∫°t m√£
      </button>

      <div id="mobile-user-info" class="hidden flex items-center space-x-4 bg-white/10 rounded-xl p-4">
        <div class="w-10 h-10 rounded-full p-1 bg-gradient-to-br from-primary to-accent">
          <img id="mobile-user-avatar" src="" alt="Avatar" class="w-full h-full rounded-full bg-white">
        </div>
        <div class="flex-1">
          <p id="mobile-username" class="text-white font-semibold"></p>
        </div>
      </div>

      <button id="mobile-login-btn" onclick="window.location.href='login.html'; toggleMobileMenu()" 
              class="bg-white text-primary px-6 py-3 rounded-full font-bold w-full hover:bg-gray-100">
        ƒêƒÉng nh·∫≠p
      </button>

      <div id="mobile-user-menu" class="hidden">
        <button onclick="logout(); toggleMobileMenu()" class="block w-full text-left py-3 px-4 bg-white/10 rounded-lg hover:bg-white/20">
          ƒêƒÉng xu·∫•t
        </button>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main class="container mx-auto px-4 py-12">
    <h1 class="text-4xl md:text-5xl font-black text-center mb-12 text-gray-800">
      Kh√≥a h·ªçc c·ªßa t√¥i
    </h1>

    <!-- COURSE GRID -->
    <div id="my-course-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
      <!-- C√°c kh√≥a h·ªçc s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
    </div>

    <!-- EMPTY STATE -->
    <div id="empty-state" class="text-center py-20 text-gray-600">
      <p class="text-3xl mb-6">B·∫°n ch∆∞a s·ªü h·ªØu kh√≥a h·ªçc n√†o üòî</p>
      <p class="text-xl mb-8">H√£y mua ho·∫∑c k√≠ch ho·∫°t m√£ ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc ngay!</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="index1.html" class="bg-gradient-to-r from-primary to-accent text-white px-8 py-4 rounded-full font-bold text-lg hover:opacity-90 transition shadow-lg">
          Xem kh√≥a h·ªçc m·ªõi
        </a>
        <button onclick="openActivateModal()" class="border-2 border-primary text-primary px-8 py-4 rounded-full font-bold text-lg hover:bg-primary hover:text-white transition">
          K√≠ch ho·∫°t m√£
        </button>
      </div>
    </div>
  </main>

  <!-- MODAL K√çCH HO·∫†T M√É (gi·ªëng index1.html) -->
  <div id="activate-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
      <h2 class="text-2xl font-black mb-4 text-gray-800">K√≠ch ho·∫°t kh√≥a h·ªçc</h2>
      <input id="activate-code" type="text" placeholder="Nh·∫≠p m√£ k√≠ch ho·∫°t"
             class="w-full px-4 py-3 border-2 border-pink-200 rounded-xl focus:border-primary focus:outline-none text-lg mb-3">
      <p id="activate-message" class="text-sm mb-4 text-red-500 min-h-[20px]"></p>
      <div class="flex gap-3">
        <button onclick="activateCode()" class="flex-1 bg-gradient-to-r from-primary to-accent text-white py-3 rounded-xl font-bold hover:opacity-90">
          K√≠ch ho·∫°t
        </button>
        <button onclick="closeActivateModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">
          H·ªßy
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = "https://wdpekgcqmwpvbfyonjih.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndkcGVrZ2NxbXdwdmJmeW9uamloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzODk4NjUsImV4cCI6MjA4MDk2NTg2NX0.qaIDzIZsGSifXO8PKM2jDAx7E6Earv2K7iFPQ8GqqaU";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Header functions (gi·ªëng index1.html)
    async function updateUserUI() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      const desktopLoginBtn = document.getElementById('desktop-login-btn');
      const mobileLoginBtn = document.getElementById('mobile-login-btn');
      const desktopUserInfo = document.getElementById('desktop-user-info');
      const mobileUserInfo = document.getElementById('mobile-user-info');
      const mobileUserMenu = document.getElementById('mobile-user-menu');

      if (!user) {
        desktopLoginBtn?.classList.remove('hidden');
        mobileLoginBtn?.classList.remove('hidden');
        desktopUserInfo?.classList.add('hidden');
        mobileUserInfo?.classList.add('hidden');
        mobileUserMenu?.classList.add('hidden');
        return;
      }

      const name = user.user_metadata?.full_name || user.user_metadata?.name || user.email.split('@')[0];
      const email = user.email;
      const avatar = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ec4899&color=fff&bold=true`;

      desktopLoginBtn?.classList.add('hidden');
      desktopUserInfo?.classList.remove('hidden');
      document.getElementById('desktop-username').textContent = name;
      document.getElementById('desktop-email').textContent = email;
      document.getElementById('desktop-user-avatar').src = avatar;

      mobileLoginBtn?.classList.add('hidden');
      mobileUserInfo?.classList.remove('hidden');
      mobileUserMenu?.classList.remove('hidden');
      document.getElementById('mobile-username').textContent = name;
      document.getElementById('mobile-user-avatar').src = avatar;
    }

    function toggleMobileMenu() {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    }

    function toggleDropdown(id) {
      document.getElementById(id).classList.toggle('hidden');
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.reload();
    }

    function openActivateModal() {
      document.getElementById('activate-modal').classList.remove('hidden');
      document.getElementById('activate-modal').classList.add('flex');
      document.body.style.overflow = 'hidden';
      document.getElementById('activate-code').focus();
    }

    function closeActivateModal() {
      document.getElementById('activate-modal').classList.add('hidden');
      document.getElementById('activate-modal').classList.remove('flex');
      document.body.style.overflow = '';
      document.getElementById('activate-code').value = '';
      document.getElementById('activate-message').textContent = '';
    }

    // H√†m activateCode (gi·ªëng index1.html - ƒë√£ fix)
    async function activateCode() {
      const code = document.getElementById('activate-code').value.trim();
      const msg = document.getElementById('activate-message');
      if (!code) {
        msg.textContent = 'Vui l√≤ng nh·∫≠p m√£ k√≠ch ho·∫°t!';
        msg.className = 'text-sm mb-4 text-red-500 min-h-[20px]';
        return;
      }
      msg.textContent = 'ƒêang ki·ªÉm tra m√£...';
      msg.className = 'text-sm mb-4 text-gray-600 min-h-[20px]';

      try {
        const { data, error } = await supabaseClient.rpc('activate_course_code', { p_code: code });
        if (error) throw error;

        let result = null;
        if (typeof data === 'string') result = data.trim().toUpperCase();
        else if (Array.isArray(data) && data.length > 0) {
          const first = data[0];
          result = (typeof first === 'string' ? first : first[Object.keys(first)[0]] || '').trim().toUpperCase();
        }

        if (result === 'SUCCESS') {
          msg.textContent = 'üéâ K√≠ch ho·∫°t th√†nh c√¥ng! ƒêang t·∫£i l·∫°i...';
          msg.className = 'text-sm mb-4 text-green-600 font-bold min-h-[20px]';
          setTimeout(() => location.reload(), 1500);
        } else if (result === 'NOT_LOGGED_IN') {
          setTimeout(() => window.location.href = 'login.html', 2000);
        } else {
          msg.textContent = {
            'INVALID_CODE': 'M√£ k√≠ch ho·∫°t kh√¥ng h·ª£p l·ªá!',
            'CODE_USED': 'M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng r·ªìi!'
          }[result] || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
          msg.className = 'text-sm mb-4 text-red-500 min-h-[20px]';
        }
      } catch (err) {
        msg.textContent = 'L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i!';
        msg.className = 'text-sm mb-4 text-red-500 min-h-[20px]';
      }
    }

   async function loadMyCourses() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('my-course-list').innerHTML = '';
    return;
  }

  // L·∫•y danh s√°ch course_id m√† user s·ªü h·ªØu
  const { data: userCourseIds, error: err1 } = await supabaseClient
    .from('user_courses')
    .select('course_id')
    .eq('user_id', user.id);

  if (err1 || !userCourseIds || userCourseIds.length === 0) {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('my-course-list').innerHTML = '';
    return;
  }

  const courseIds = userCourseIds.map(row => row.course_id);

  // L·∫•y th√¥ng tin chi ti·∫øt c√°c kh√≥a h·ªçc
  const { data: courses, error: err2 } = await supabaseClient
    .from('courses')
    .select('*')
    .in('id', courseIds);

  if (err2 || !courses || courses.length === 0) {
    document.getElementById('empty-state').classList.remove('hidden');
    return;
  }

  document.getElementById('empty-state').classList.add('hidden');
  const container = document.getElementById('my-course-list');
  container.innerHTML = '';

  courses.forEach(course => {
    const card = document.createElement('div');
    card.className = 'group block';

    card.innerHTML = `
      <div class="relative overflow-hidden rounded-3xl shadow-lg hover:shadow-2xl border border-pink-100 flex flex-col h-full">
        <div class="relative overflow-hidden">
          <img src="${course.image_url || 'https://via.placeholder.com/800x450?text=' + encodeURIComponent(course.title)}" 
               alt="${course.title}"
               class="w-full h-56 object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
        </div>
        <div class="p-6 bg-gradient-to-b from-white to-pink-50 flex flex-col flex-1 justify-between">
          <div>
            <h3 class="text-xl font-black text-gray-800 mb-3 line-clamp-2">${course.title}</h3>
            <p class="text-gray-600 text-sm mb-4">${course.description || '1 nƒÉm ‚Ä¢ Ch·∫•t l∆∞·ª£ng cao'}</p>
            ${course.price ? `<p class="text-lg font-bold text-primary">${course.price.toLocaleString()}ƒë</p>` : ''}
          </div>
          <button onclick="window.location.href='readingtest/index.html?id=${course.id}'"
                  class="mt-6 w-full py-4 bg-gradient-to-r from-primary to-accent text-white text-lg font-bold rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
            V√†o h·ªçc ngay
          </button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

    // Kh·ªüi ch·∫°y
    window.addEventListener('load', () => {
      updateUserUI();
      loadMyCourses();
    });

    supabaseClient.auth.onAuthStateChange(() => {
      updateUserUI();
      loadMyCourses();
    });

    // Modal events
    document.getElementById('activate-modal')?.addEventListener('click', e => {
      if (e.target.id === 'activate-modal') closeActivateModal();
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeActivateModal();
    });
    
  </script>
<footer class="bg-gradient-to-r from-primary to-accent text-white py-8 mt-20">
  <div class="max-w-7xl mx-auto px-6 text-center">
    <p class="text-sm font-medium">
      ¬© 2025 Developed by <span class="font-bold">Ph·∫°m Nh·∫≠t Huy</span>. All rights reserved.
    </p>
  </div>
</footer>
</body>
</html>